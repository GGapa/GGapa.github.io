<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>高级随机点名器</title>
    <style>
        body {
            margin: 0;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Arial', sans-serif;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 80%;
            max-width: 600px;
            text-align: center; /* Center content within container */
        }

        #display {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin: 2rem 0;
            perspective: 1000px;
        }

        .name-card {
            position: absolute;
            padding: 2rem;
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            font-size: 2.5rem;
            font-weight: bold;
            color: #2d3748;
            opacity: 0;
            transform: scale(0.8) rotateX(-30deg);
            transition: all 0.6s cubic-bezier(0.25, 0.1, 0.25, 1);
            pointer-events: none;
        }

        .name-card.active {
            opacity: 1;
            transform: scale(1) rotateX(0deg);
            z-index: 1;
        }

        button {
            padding: 1rem 2rem;
            font-size: 1.2rem;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0.5rem; /* Add margin for spacing between buttons */
        }

        button:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Style for the smaller "显示名单" button */
        #showListBtn {
            padding: 0.6rem 1.5rem; /* Smaller padding */
            font-size: 1rem; /* Smaller font size */
            background: #007bff; /* Different color for distinction */
        }

        #showListBtn:hover {
             background: #0056b3;
        }


        .loading {
            display: none;
            color: #4a5568;
            font-size: 1.2rem;
            text-align: center;
        }

        input[type="file"] {
            margin: 1rem auto; /* Center file input */
            padding: 0.5rem;
            border: 2px solid #ddd;
            border-radius: 5px;
            width: calc(100% - 1rem); /* Adjust width for padding */
            max-width: 400px; /* Limit max width */
            display: block; /* Make it a block element for margin: auto */
        }

        .info-panel {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            color: #4a5568;
            font-size: 1rem;
            width: 100%; /* Ensure info panel takes full width */
        }

        .full-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
            background: #f8f9fa;
            border-radius: 5px;
            margin-top: 1rem;
            padding: 0 1rem; /* Adjust padding */
            text-align: left; /* Align text left */
            color: #2d3748;
            line-height: 1.6; /* Improve readability */
        }

        .full-list.show {
            max-height: 300px; /* Adjust as needed */
            overflow-y: auto;
            padding: 1rem; /* Full padding when shown */
        }

        /* Remove specific item styling */
        /* .full-list-item {
            padding: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        } */

        .button-group {
            display: flex;
            flex-direction: column; /* Stack buttons vertically */
            align-items: center; /* Center buttons horizontally */
            margin-top: 1rem; /* Add space above buttons */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="info-panel">
            <div>当前人数: <span id="count">0</span></div>
            <div id="last-loaded"></div>
        </div>

        <input type="file" id="fileInput" accept=".txt" title="请选择名单文件">
        <div id="display">
            <div class="loading">正在加载名单...</div>
        </div>
        <div class="button-group">
            <button id="startBtn">开始点名</button>
            <button id="showListBtn">显示名单</button>
        </div>
        <div class="full-list" id="fullList"></div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const display = document.getElementById('display');
        const startBtn = document.getElementById('startBtn');
        const showListBtn = document.getElementById('showListBtn');
        const loading = document.querySelector('.loading');
        const countSpan = document.getElementById('count');
        const lastLoadedSpan = document.getElementById('last-loaded');
        const fullList = document.getElementById('fullList');
        let names = [];
        let isRunning = false;

        // 初始化时加载上次的名单
        window.addEventListener('DOMContentLoaded', () => {
            const savedNames = localStorage.getItem('lastNameList');
            const lastLoadedTime = localStorage.getItem('lastLoadedTime');

            if (savedNames) {
                names = JSON.parse(savedNames);
                createNameCards();
                updateCount();
                updateFullList();

                if (lastLoadedTime) {
                    const time = new Date(parseInt(lastLoadedTime));
                    lastLoadedSpan.textContent = `加载时间: ${time.toLocaleString()}`;
                }
            }
        });

        // 增强随机函数
        function secureRandom(max) {
            if (max <= 0) return 0; // Handle empty list case
            const array = new Uint32Array(1);
            window.crypto.getRandomValues(array);
            return array[0] % max;
        }

        function createNameCards() {
             // Clear previous cards
            display.innerHTML = '';
            if (names.length === 0) {
                 display.innerHTML = '<div class="loading">请加载名单文件</div>'; // Show a message if list is empty
                 loading.style.display = 'block'; // Ensure message is visible
                 return;
            }
            loading.style.display = 'none'; // Hide loading if names are loaded

            // Create new cards
            names
                .map(name => `<div class="name-card">${name}</div>`)
                .forEach(cardHtml => display.innerHTML += cardHtml); // Append cards
        }

        function updateCount() {
            countSpan.textContent = names.length;
        }

        function updateFullList() {
            if (names.length > 0) {
                 // Join names with comma and space
                fullList.innerHTML = names.join(', ');
            } else {
                fullList.innerHTML = '名单为空';
            }
        }

        function startAnimation() {
            if (!names.length || isRunning) {
                 if (!names.length) {
                    alert('请先加载名单！');
                 }
                 return;
            }

            isRunning = true;
            startBtn.disabled = true;
            startBtn.textContent = '随机选择中...';

            const cards = display.querySelectorAll('.name-card');
            if (cards.length === 0) {
                 // This should not happen if names.length > 0, but as a safeguard
                 isRunning = false;
                 startBtn.disabled = false;
                 startBtn.textContent = '开始点名';
                 alert('没有可供点名的人员卡片！');
                 return;
            }

            // 预先生成随机结果
            const targetIndex = secureRandom(names.length);

            // 初始状态
            cards.forEach(card => card.classList.remove('active'));

            // Animation parameters
            const totalDuration = 3000; // Total animation duration in ms
            const interval = 100; // Initial interval
            let elapsed = 0;
            let lastIndex = -1;

            const animate = () => {
                elapsed += interval;

                if (elapsed >= totalDuration) {
                    // Ensure the final card is the target one
                    cards.forEach((card, i) => {
                        card.classList.toggle('active', i === targetIndex);
                    });

                    isRunning = false;
                    startBtn.disabled = false;
                    startBtn.textContent = '开始点名';
                    return;
                }

                // Select a random index different from the last one if possible
                let randomIndex;
                do {
                    randomIndex = secureRandom(names.length);
                } while (names.length > 1 && randomIndex === lastIndex); // Avoid picking the same index twice in a row if list > 1

                cards.forEach((card, i) => {
                    card.classList.toggle('active', i === randomIndex);
                });
                lastIndex = randomIndex;

                // Calculate next interval (slowing down)
                const remainingTime = totalDuration - elapsed;
                const nextInterval = Math.max(50, interval + (remainingTime / 10)); // Ensure minimum interval

                setTimeout(animate, nextInterval);
            };

            animate();
        }

        fileInput.addEventListener('change', function(e) {
            loading.style.display = 'block';
            loading.textContent = '正在加载名单...'; // Reset loading text
            const file = e.target.files[0];

            if (!file) {
                 loading.style.display = 'none';
                 return;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                names = e.target.result.split('\n')
                    .map(name => name.trim())
                    .filter(name => name !== '');

                if (names.length > 0) {
                    createNameCards();
                    updateCount();
                    updateFullList();
                    loading.style.display = 'none';

                    // Save to local storage
                    localStorage.setItem('lastNameList', JSON.stringify(names));
                    const now = new Date().getTime();
                    localStorage.setItem('lastLoadedTime', now.toString());

                    // Update display info
                    lastLoadedSpan.textContent = `加载时间: ${new Date(now).toLocaleString()}`;
                } else {
                    loading.textContent = '没有找到有效名单，请检查文件内容';
                    display.innerHTML = ''; // Clear display if no names
                    updateCount();
                    updateFullList();
                    localStorage.removeItem('lastNameList'); // Clear storage if list is empty
                    localStorage.removeItem('lastLoadedTime');
                    lastLoadedSpan.textContent = '';
                }
            };

            reader.onerror = function() {
                 loading.textContent = '文件读取失败！';
                 display.innerHTML = '';
                 names = [];
                 updateCount();
                 updateFullList();
                 localStorage.removeItem('lastNameList');
                 localStorage.removeItem('lastLoadedTime');
                 lastLoadedSpan.textContent = '';
            }

            reader.readAsText(file);
        });

        startBtn.addEventListener('click', startAnimation);

        showListBtn.addEventListener('click', function() {
            fullList.classList.toggle('show');
            this.textContent = fullList.classList.contains('show') ? '隐藏名单' : '显示名单';
        });
    </script>
</body>
</html>
